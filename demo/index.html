<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />
  <!-- Force Edge to stop detecting phone numbers -->
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Demo</title>
</head>
<body>
<p>
  <button id="loginBtn">Login</button>
</p>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.2.2/es6-promise.js"></script>
<script type="text/javascript" src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.1.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fetch/0.11.1/fetch.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/ringcentral/ringcentral-js/3.2.2/build/ringcentral.js"></script>
<script src="../build/index.js"></script>
<script>
  var environment = {
    server: 'https://platform.devtest.ringcentral.com',
    appKey: '66TmFtzLTKaIQzLT-d71_w',
  };
  function getRedirectUri() {
    if (window.location.pathname.indexOf('/index.html') > 0) {
      return window.location.protocol + '//' + window.location.host + window.location.pathname.replace('/index.html', '') + '/redirect.html';
    }
    return window.location.protocol + '//' + window.location.host + window.location.pathname + 'redirect.html';
  }
  var rcsdk = new RingCentral.SDK({
    cachePrefix: 'rc-call-control',
    server: environment.server,
    appKey: environment.appKey,
    redirectUri: getRedirectUri(),
  });
  var platform = rcsdk.platform();
  var loggedIn = false;
  var loginBtn = document.getElementById('loginBtn');
  var subscriptionCacheKey = 'rc-call-control-subscription-key';
  var subscription = null;

  function onLoginSuccess() {
    loginBtn.innerText = 'Logout';
    window.rcCallControl = new RingCentralCallControl({ sdk: rcsdk });
    subscription = rcsdk.createSubscription();
    var cachedSubscriptionData = rcsdk.cache().getItem(subscriptionCacheKey);

    if (cachedSubscriptionData) {
      try {
        subscription.setSubscription(cachedSubscriptionData); // use the cache
      } catch (e) {
        console.error('Cannot set subscription from cache data', e);
        subscription.setEventFilters([
          '/restapi/v1.0/account/~/extension/~/telephony/sessions',
        ]);
      }
    } else {
      subscription.setEventFilters([
        '/restapi/v1.0/account/~/extension/~/telephony/sessions',
      ]);
    }
    subscription.on([subscription.events.subscribeSuccess, subscription.events.renewSuccess], function() {
      rcsdk.cache().setItem(cacheKey, subscription.subscription());
    });
    subscription.on(subscription.events.notification, function(msg) {
      window.rcCallControl.onNotificationEvent(msg)
    });
    subscription.register();
  }

  platform.loggedIn().then(function(isLogin) {
    loggedIn = isLogin;
    if (!loggedIn) {
      return;
    }
    onLoginSuccess();
  });
  loginBtn.addEventListener('click', function() {
    if (loggedIn) {
      platform.logout().then(function() {
        window.location.reload();
      }).catch(function() {
        window.location.reload();
      });
      return;
    }
    var loginUrl = platform.loginUrl({ implicit: true });
    platform.loginWindow({ url: loginUrl })
            .then(function (loginOptions){
              return platform.login(loginOptions);
            })
            .then(function() {
              onLoginSuccess();
            })
            .catch(function(e) {
                console.error(e.stack || e);
            });
  });
</script>
</body>
</html>
